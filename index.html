<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>NICO-VOXBOT ACADEMY ‚Äî Todo integrado</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f3f6fb;color:#102a43;}
  header{background:#1f3b69;color:white;padding:18px;text-align:center}
  .wrap{max-width:980px;margin:18px auto;padding:0 12px}
  .card{background:white;border-radius:10px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #dfe7ef;margin-top:8px;box-sizing:border-box}
  button{background:#1f3b69;color:white;border:none;cursor:pointer}
  .row{display:flex;gap:10px}
  .row > *{flex:1}
  .small{font-size:0.9rem;color:#334e68}
  .float-ia{position:fixed;right:18px;bottom:90px;background:linear-gradient(135deg,#1e90ff,#00c3ff);color:white;padding:12px 16px;border-radius:999px;box-shadow:0 8px 24px rgba(30,144,255,0.25);z-index:9999;cursor:pointer}
  .medalla{font-size:22px}
  .exam{background:#fff7e6;padding:12px;border-radius:8px;margin-top:10px}
  ul{padding-left:18px}
</style>
</head>
<body>

<header>
  <h1>NICO-VOXBOT ACADEMY</h1>
  <div><strong>La Forma M√°s Inteligente de Aprender Cualquier Idioma</strong></div>
</header>

<div class="wrap">

  <div class="card">
    <strong>Somos una plataforma que ofrece clases de idiomas de la forma m√°s accesible e inteligente para garantizar su futuro, y a un precio muy asequible.</strong>
    <div class="small">Contacto: academynicovoxbot@gmail.com ¬∑ Soporte: 829-742-5652</div>
  </div>

  <div class="card">
    <h3>Planes</h3>
    <p class="small">Mensual: <strong>US$3.99</strong> ¬∑ Anual: <strong>US$39.99</strong></p>
    <button onclick="alert('Pago PRO en versi√≥n avanzada')">Suscribirse</button>
  </div>

  <div class="card" id="panel-registro">
    <h3>Registro / Acceso</h3>
    <input id="nombre" placeholder="Nombre completo"/>
    <div class="row">
      <input id="edad" placeholder="Edad"/>
      <input id="email" placeholder="Correo"/>
    </div>
    <div class="row">
      <button onclick="registrar()">Registrarse</button>
      <button onclick="abrirLogin()">Iniciar Sesi√≥n</button>
    </div>
  </div>

  <div class="card hidden" id="panel-login">
    <h3>Iniciar Sesi√≥n</h3>
    <input id="loginEmail" placeholder="Correo registrado"/>
    <div class="row">
      <button onclick="entrar()">Entrar</button>
      <button onclick="cerrarLogin()">Cancelar</button>
    </div>
  </div>

  <div class="card hidden" id="panel-curso">
    <h2>üéÆ Mi Curso (Juego + Lecciones)</h2>

    <label><strong>Idioma</strong></label>
    <select id="idioma" onchange="cambiarIdioma()">
      <option>Ingl√©s</option><option>Franc√©s</option><option>Portugu√©s</option>
      <option>Alem√°n</option><option>Italiano</option><option>Chino</option>
      <option>Japon√©s</option><option>Coreano</option><option>Ruso</option>
      <option>√Årabe</option><option>Hebreo</option><option>Turco</option>
      <option>Holand√©s</option><option>Sueco</option><option>Noruego</option>
      <option>Polaco</option><option>Griego</option><option>Hindi</option>
      <option>Tailand√©s</option><option>Indonesia</option>
    </select>

    <div style="display:flex;gap:10px;margin-top:10px">
      <div style="flex:1"><strong>Nivel:</strong> <span id="nivel">1</span></div>
      <div style="flex:1"><strong>Puntos:</strong> <span id="puntos">0</span></div>
      <div style="flex:1"><strong>Medalla:</strong> <span id="medallas" class="medalla">ü•â</span></div>
    </div>

    <div style="margin-top:12px">
      <h3 id="pregunta">Cargando...</h3>
      <div class="row" style="margin-top:8px">
        <button class="option" onclick="respuesta(this.innerText)">Opci√≥n A</button>
        <button class="option" onclick="respuesta(this.innerText)">Opci√≥n B</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="option" onclick="respuesta(this.innerText)">Opci√≥n C</button>
        <button class="option" onclick="respuesta(this.innerText)">Opci√≥n D</button>
      </div>

      <p id="mensaje" class="small"></p>

      <div id="examen" class="exam hidden">
        <h4>üìù Examen del nivel</h4>
        <p id="pregExamen"></p>
        <div class="row">
          <button onclick="responderExamen(true)">‚úÖ Verdadero</button>
          <button onclick="responderExamen(false)">‚ùå Falso</button>
        </div>
      </div>

      <hr style="margin:12px 0">

      <h4>Acciones IA (Chatbase)</h4>
      <div class="row">
        <button onclick="peticionExamChatbase()">Pedir examen (Chatbase)</button>
        <button onclick="peticionTareasSemanal()">Pedir tareas semanales</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button onclick="generarCertificado()">Generar certificado (PDF)</button>
        <button onclick="pedirExplicacion()">Pedir explicaci√≥n (IA)</button>
      </div>

      <p class="small">Cuando Chatbase responda, la respuesta se mostrar√° en el chat flotante y sonar√° (voz).</p>
    </div>

    <hr style="margin:12px 0">
    <h4>Ranking y progreso</h4>
    <ul id="ranking"></ul>

    <div style="margin-top:10px" class="row">
      <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
      <button onclick="guardarTodo()">Guardar ahora</button>
    </div>
  </div>

  <div class="card">
    <h4>Aliado: LibreLingo</h4>
    <div class="small">Prueba las lecciones completas desde LibreLingo y vuelve a NICO para practicar con el profesor IA.</div>
    <div style="margin-top:8px" class="row">
      <button onclick="window.open('https://librelingo.app','_blank')">Abrir LibreLingo</button>
      <button onclick="mostrarIframeLibre()">Abrir aqu√≠</button>
    </div>
    <div id="libreFrame" style="display:none;margin-top:10px">
      <iframe src="https://librelingo.app" style="width:100%;height:420px;border-radius:8px;border:1px solid #e3eef8"></iframe>
      <button onclick="cerrarIframeLibre()">Cerrar</button>
    </div>
  </div>

</div>

<!-- Bot√≥n IA flotante (abre el widget Chatbase) -->
<div class="float-ia" onclick="window.chatbase && window.chatbase('open')">
  ü§ñ Hablar con IA
</div>

<!-- ---------- SCRIPTS: juego, banco 10k din√°mico, ex√°menes, tareas, certificado, chatbase ---------- -->
<script>
/* === Config y banco din√°mico (10k por idioma, perezoso) === */
const PREGUNTAS_POR_IDIOMA = 10000;
const PREGUNTAS_POR_NIVEL = 20;
const idiomasList = Array.from(document.querySelectorAll('#idioma option')).map(o=>o.textContent);

let progreso = JSON.parse(localStorage.getItem('progreso'))||{};
let idiomaActual = 'Ingl√©s';
let preguntaActual = null;
let enExamen = false;
let aciertosExamen = 0;
const bankCache = {}; // lazy generated

function ensureBank(idioma){
  if(bankCache[idioma]) return;
  const arr=[];
  for(let i=0;i<PREGUNTAS_POR_IDIOMA;i++){
    const nivel = Math.floor(i/PREGUNTAS_POR_NIVEL)+1;
    const palabra = `${idioma.substr(0,3).toUpperCase()}_WORD_${i+1}`;
    const correcta = `Traducci√≥n_${i+1}`;
    // distractores simples
    const opts = [correcta, `Op_${i+101}`, `Op_${i+202}`, `Op_${i+303}`];
    // mezclar
    for(let j=opts.length-1;j>0;j--){
      const k=Math.floor(Math.random()*(j+1)); [opts[j],opts[k]]=[opts[k],opts[j]];
    }
    arr.push({nivel,palabra,correcta,opciones:opts});
  }
  bankCache[idioma]=arr;
}

/* === UI helpers === */
function $(id){return document.getElementById(id)}
function show(el){el.classList.remove('hidden')}
function hide(el){el.classList.add('hidden')}

/* === Registro / Login / Sesi√≥n === */
function registrar(){
  const name=$('nombre').value.trim(), age=$('edad').value, email=$('email').value.trim();
  if(!name||!email){alert('Nombre y correo son obligatorios'); return;}
  localStorage.setItem('user_nombre',name);
  localStorage.setItem('user_email',email);
  // init progreso por idiomas si no existe
  idiomasList.forEach(lang=>{ if(!progreso[lang]) progreso[lang]={nivel:1,puntos:0,history:[]}; });
  localStorage.setItem('progreso',JSON.stringify(progreso));
  alert('Registrado: '+name);
  hide($('panel-registro'));
  show($('panel-login'));
}
function abrirLogin(){ hide($('panel-registro')); show($('panel-login')) }
function cerrarLogin(){ show($('panel-registro')); hide($('panel-login')) }
function entrar(){
  const em = $('loginEmail').value.trim() || localStorage.getItem('user_email');
  if(!em){ alert('Escribe tu correo'); return; }
  localStorage.setItem('user_email', em);
  hide($('panel-login'));
  show($('panel-curso'));
  actualizarChatbase(); // actualizamos Chatbase con usuario al entrar
  cambiarIdioma(); // carga preguntas
}

/* === Juego / preguntas / progreso === */
function cambiarIdioma(){
  idiomaActual = $('idioma').value;
  if(!progreso[idiomaActual]) progreso[idiomaActual]={nivel:1,puntos:0,history:[]};
  ensureBank(idiomaActual);
  generarPregunta();
  actualizar();
}
function generarPregunta(){
  const datos = progreso[idiomaActual];
  const listaNivel = bankCache[idiomaActual].filter(q=>q.nivel===datos.nivel);
  if(!listaNivel || listaNivel.length===0){
    $('pregunta').innerText = '‚úÖ No hay preguntas para este nivel (a√∫n).';
    return;
  }
  preguntaActual = listaNivel[Math.floor(Math.random()*listaNivel.length)];
  $('pregunta').innerText = preguntaActual.palabra;
  const btns = document.querySelectorAll('.option');
  btns.forEach((b,i)=> b.innerText = preguntaActual.opciones[i] || ('Opci√≥n '+(i+1)));
  hablar(preguntaActual.palabra); // voz para la palabra
}
function respuesta(valor){
  if(enExamen) return;
  const datos = progreso[idiomaActual];
  if(!preguntaActual){ generarPregunta(); return; }
  if(valor === preguntaActual.correcta){
    datos.puntos += 10; datos.nivel += 1;
    $('mensaje').innerText = '‚úÖ Correcto';
  } else {
    $('mensaje').innerText = '‚ùå Incorrecto';
  }
  datos.history.push({q:preguntaActual.palabra, ans:valor, ok: valor===preguntaActual.correcta, when:Date.now()});
  guardarProgreso();
  verificarExamen();
  generarPregunta();
  actualizar();
}
/* Examen local (y chatbase puede crear uno personalizado) */
function verificarExamen(){
  const datos = progreso[idiomaActual];
  if(datos.nivel % 5 === 0){
    enExamen = true; aciertosExamen = 0;
    $('examen').classList.remove('hidden');
    $('pregExamen').innerText = 'EXAMEN: Responde Verdadero si la traducci√≥n propuesta es correcta.';
    // la UI de examen usa botones Verdadero / Falso
  }
}
function responderExamen(resp){
  if(!enExamen) return;
  if(resp) aciertosExamen++;
  // regla local: 3 aciertos (para versi√≥n demo) -> aprobado
  if(aciertosExamen >= 3){
    $('mensaje').innerText = 'üéâ Examen aprobado';
    progreso[idiomaActual].puntos += 30;
  } else {
    $('mensaje').innerText = '‚ùå Reprobaste el examen, repite el nivel';
    progreso[idiomaActual].nivel = Math.max(1, progreso[idiomaActual].nivel - 1);
  }
  $('examen').classList.add('hidden');
  enExamen = false;
  guardarProgreso();
  generarPregunta();
  actualizar();
}

/* === Ranking / medallas / certificado === */
function actualizar(){
  const datos = progreso[idiomaActual];
  $('nivel').innerText = datos.nivel;
  $('puntos').innerText = datos.puntos;
  if(datos.puntos>=100) $('medallas').innerText='ü•á';
  else if(datos.puntos>=50) $('medallas').innerText='ü•à';
  else $('medallas').innerText='ü•â';
  $('ranking').innerHTML = `<li>${idiomaActual} - ${datos.puntos} pts</li>`;
  if(datos.nivel >= 10){
    $('certificado').innerText = `‚úÖ Certificado desbloqueado en ${idiomaActual}`;
  } else $('certificado').innerText = '';
  // actualizar informaci√≥n en Chatbase para que el tutor la use
  actualizarChatbase();
}
function guardarProgreso(){
  localStorage.setItem('progreso', JSON.stringify(progreso));
}
function guardarTodo(){ guardarProgreso(); alert('Progreso guardado'); }

/* === Voz local === */
function hablar(texto){
  try{
    const u = new SpeechSynthesisUtterance(texto);
    speechSynthesis.speak(u);
  }catch(e){ /* ignore */ }
}

/* ========== CHATBASE INTEGRATION ========== */
/*
  - setUserData: enviamos datos para que el agente use contexto
  - askChatbase: pedimos al agente que genere examen/tareas/explicaci√≥n
  Nota: la funci√≥n intenta distintos m√©todos de client API; si tu versi√≥n de Chatbase usa otro nombre,
  com√©ntamelo y lo adaptamos. Mientras tanto hay fallback local.
*/
function actualizarChatbase(){
  if(!window.chatbase) return;
  const user = localStorage.getItem('user_email') || 'invitado@nicovoxbot.com';
  const datos = progreso[idiomaActual] || {nivel:1,puntos:0};
  try{
    window.chatbase('setUserData', { email: user, idioma: idiomaActual, nivel: datos.nivel, puntos: datos.puntos });
  }catch(e){ /* no cr√≠tico */ }
}

/* funci√≥n gen√©rica que intenta pedir respuesta al agente */
function askChatbase(prompt, onResponse){
  // normalizamos
  if(!window.chatbase){
    onResponse && onResponse({error:'Chatbase no disponible en esta sesi√≥n'});
    return;
  }
  // intentamos dos formas, seg√∫n embed client API
  try {
    // forma 1: m√©todo 'ask' (hipot√©tico)
    window.chatbase('ask', { prompt, onResult: (res)=> {
      // si el embed llama al callback
      if(res && res.text){
        onResponse && onResponse({text: res.text});
        hablar(res.text);
      }
    }});
    // tambi√©n intentamos forma 2: sendMessage
    window.chatbase('sendMessage', { role:'user', content: prompt }).then((res)=>{
      if(res && res.text){ onResponse && onResponse({text: res.text}); hablar(res.text); }
    }).catch(()=>{ /* ignore */ });
    // como muchas embed libs no retornan promesas, devolvemos ya
    onResponse && onResponse({text:'Solicitud enviada a Chatbase. El agente responder√° en su widget.'});
  } catch(err){
    // fallback: env√≠a setUserData y abre el widget con la instrucci√≥n visible
    try {
      window.chatbase('setUserData', { prompt_example: prompt });
      window.chatbase('open');
      onResponse && onResponse({text:'Abriendo widget para que el agente responda (fallback).'});
    } catch(e){
      onResponse && onResponse({error:'No se pudo comunicar con Chatbase desde esta p√°gina.'});
    }
  }
}

/* === 1) Petici√≥n de examen hecho por Chatbase === */
function peticionExamChatbase(){
  const prompt = `Eres el profesor de NICO-VOXBOT. Crea un examen de 5 preguntas para un estudiante en ${idiomaActual} en su nivel ${progreso[idiomaActual].nivel}. Responde en formato: pregunta || opci√≥n1; opci√≥n2; opci√≥n3; opci√≥n4 || respuesta_correcta`;
  askChatbase(prompt, (res)=>{
    if(res && res.text){
      // mostramos en el widget: abrimos chat y dejamos la respuesta
      alert('Chatbase respondi√≥: revisa el widget (o escucha la respuesta).');
      // tambi√©n intentamos procesar texto si viene en formato esperado
    } else if(res && res.error){
      alert('Error Chatbase: '+res.error + '. Se usar√° examen local.');
      // fallback: mostramos un examen local ya presente (verificar)
      verificarExamen();
    }
  });
}

/* === 2) Petici√≥n de tareas semanales === */
function peticionTareasSemanal(){
  const prompt = `Eres el tutor. Genera 5 tareas pr√°cticas para la semana para un estudiante de nivel ${progreso[idiomaActual].nivel} en ${idiomaActual}. Indica duraci√≥n estimada por tarea.`;
  askChatbase(prompt, (res)=>{
    if(res && res.text){
      alert('Tareas creadas por Chatbase (revisa widget).');
      // guardamos tarea simple en localStorage (si queremos)
      const tareas = JSON.parse(localStorage.getItem('tareas'))||{};
      tareas[idiomaActual] = tareas[idiomaActual] || [];
      tareas[idiomaActual].push({when:Date.now(), text: res.text});
      localStorage.setItem('tareas', JSON.stringify(tareas));
    } else {
      alert('No hay respuesta de Chatbase. Se cre√≥ una tarea local de ejemplo.');
      const tareas = JSON.parse(localStorage.getItem('tareas'))||{};
      tareas[idiomaActual] = tareas[idiomaActual] || [];
      tareas[idiomaActual].push({when:Date.now(), text: 'Practica 15 min de vocabulario y 10 min escuchar audio.'});
      localStorage.setItem('tareas', JSON.stringify(tareas));
    }
  });
}

/* === 3) Generar certificado PDF/Imprimir (client-side) === */
function generarCertificado(){
  const name = localStorage.getItem('user_nombre') || 'Estudiante';
  const idioma = idiomaActual;
  const nivel = progreso[idiomaActual] ? progreso[idiomaActual].nivel : 1;
  // Creamos una ventana con contenido imprimible (f√°cil y compatible)
  const w = window.open('','_blank');
  const html = `
    <html><head><title>Certificado</title>
    <style>body{font-family:Arial;text-align:center;padding:40px} h1{color:#1f3b69}</style></head>
    <body>
      <h1>Certificado de Finalizaci√≥n</h1>
      <p>Este certificado acredita que</p>
      <h2>${name}</h2>
      <p>ha completado el nivel ${nivel} del curso de <strong>${idioma}</strong> en NICO-VOXBOT ACADEMY.</p>
      <p>Fecha: ${new Date().toLocaleDateString()}</p>
      <p style="margin-top:40px">--- NICO-VOXBOT ACADEMY ---</p>
    </body></html>`;
  w.document.write(html);
  w.document.close();
  w.focus();
  // Intentamos imprimir / guardar como PDF
  setTimeout(()=>{ w.print(); }, 700);
}

/* === 4) Pedir explicaci√≥n / pedir ejercicio al tutor IA === */
function pedirExplicacion(){
  const prompt = `Expl√≠came la palabra "${preguntaActual ? preguntaActual.palabra : '...' }" en ${idiomaActual} a nivel del estudiante (nivel ${progreso[idiomaActual].nivel}). Da ejemplos y un mini-ejercicio.`;
  askChatbase(prompt, (res)=>{
    if(res && res.text) {
      alert('El profesor IA respondi√≥ (ver widget).');
    } else if(res && res.error){
      alert('Chatbase no disponible: intenta de nuevo m√°s tarde.');
    }
  });
}

/* === Petici√≥n para cerrar iframe librelingo === */
function mostrarIframeLibre(){ $('libreFrame').style.display='block' }
function cerrarIframeLibre(){ $('libreFrame').style.display='none' }

/* === iniciar la app con valores si ya hay progreso === */
document.addEventListener('DOMContentLoaded', ()=>{
  // inicializar progreso base si no existe
  idiomasList.forEach(lang=>{ if(!progreso[lang]) progreso[lang] = {nivel:1,puntos:0,history:[]}; });
  // registrar usuario por defecto si existe local
  const name = localStorage.getItem('user_nombre');
  if(name){
    hide($('panel-registro'));
    show($('panel-curso'));
  }
  // generamos banco del idioma por defecto de forma lazy (no todo a la vez)
  ensureBank(idiomaActual);
  generarPregunta();
  actualizar();
  // inicializar Chatbase embed (script) ‚Äî lo agregamos din√°micamente abajo (si falla, se mostrar√° aviso)
});
</script>

<!-- ================== Chatbase embed script (√∫ltimo para que cargue despu√©s del resto) ================== -->
<script>
(function(){
  // Este bloque es el embed oficial (tal como el code que copiaste antes).
  // ID de script es el que Chatbase te da en tu agente; si tu scriptId es distinto, reempl√°zalo.
  if(!window.chatbase || window.chatbase("getState") !== "initialized"){
    window.chatbase=(...args)=>{ if(!window.chatbase.q) window.chatbase.q=[]; window.chatbase.q.push(args); };
    window.chatbase = new Proxy(window.chatbase, { get(target, prop){
      if(prop === 'q') return target.q;
      return (...a) => target(prop, ...a);
    }});
  }
  const onLoad = function(){
    const s = document.createElement('script');
    s.src = 'https://www.chatbase.co/embed.min.js';
    s.id = 'fxrgAJ48ExA_xk5xf9j_0';
    s.defer = true;
    document.body.appendChild(s);
  };
  if(document.readyState === 'complete') onLoad();
  else window.addEventListener('load', onLoad);
})();
</script>

</body>
</html>
